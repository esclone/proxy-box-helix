interface Config {
  policy: Object;
  log: Object;
  inbounds: Object;
  outbounds: Object;
  stats: Object;
  api: Object;
  routing: Object;
  dns?: Object;
}

interface UIServerConfig {
  // Default: 0.0.0.0
  InboundAddress: string;
  // 1-65535
  InboundPort: number;
  // [vless|vmess] Unsupport: tunnel/http/shadowsocks/socks/trojan/wireguard
  // https://xtls.github.io/development/protocols/vless.html
  // https://xtls.github.io/development/protocols/vmess.html
  InboundProtocol: string;
  // Default: false
  sniffingEnabled: boolean;
  InboundUUID: string;
  // https://xtls.github.io/config/transport.html
  // XHTTP: https://github.com/XTLS/Xray-core/discussions/4113
  InboundStreamType: 'raw' | 'xhttp' | 'kcp' | 'grpc' | 'ws' | 'httpupgrade' | 'hysteria';
  // vmess: auto/aes-128-gcm/chacha20-poly1305/none; vless: none
  // Default: none
  // VLESS Encryption: https://github.com/XTLS/Xray-core/pull/5067
  InboundDecryption?: string;
  InboundFlow?: '' | 'xtls-rprx-vision';
  // Default: none
  InboundStreamSecurity: 'none' | 'tls' | 'reality';
  // ws/httpupgrade/xhttp path
  InboundPath: string;
  // Default: auto
  InboundXHTTPMode?: 'auto' | 'packet-up' | 'stream-up' | 'stream-one';
  InboundXHTTPExtra?: any;
  // {
  //   "target": "a1.example.com",    // 目标网站最低标准：国外网站，支持 TLSv1.3、X25519 与 H2，域名非跳转用（主域名可能被用于跳转到 www） 更多内容请见 https://github.com/XTLS/Xray-core/discussions/2256#discussioncomment-6295296
  //   "serverNames": [    // 客户端可用的 serverName 列表，暂不支持 * 通配符，在 Chrome 里输入 "dest" 的网址 -> F12 -> 安全 -> F5 -> 主要来源（安全），填证书中 SAN 的值
  //     "a1.example.com",
  //     "a2.example.com"
  //   ],
  //   "privateKey": "$(your_privateKey)",    // 执行 xray x25519 生成一对公钥与私钥，服务端填私钥 "Private key" 的值，客户端填公钥 "Public key" 的值
  //   "shortIds": ["$(your_shortId)"]    // 客户端可用的 shortId 列表，可用于区分不同的客户端，0 到 f，长度为 2 的倍数，长度上限为 16，可留空，或执行 openssl rand -hex 1到8 生成
  // }
  InboundRealityExtra?: any;
  InboundCustom?: any;
  DnsServerCustom?: any;
  RoutingCustom?: any;
  OutboundCustom?: any;
}

export default class CoreConfigHandler {
  public generateServerConfig(UIServerConfig: UIServerConfig): object {
    // 初始化配置
    let config: Config = {
      policy: new Object(),
      log: new Object(),
      inbounds: new Object(),
      outbounds: new Object(),
      stats: new Object(),
      api: new Object(),
      routing: new Object(),
      dns: new Object(),
    };

    // 流量统计
    // config.policy = {
    //     system: {
    //         statsOutboundUplink: true,
    //         statsOutboundDownlink: true
    //     }
    // };

    // 日志
    config.log = {
      access: '',
      error: '',
      loglevel: 'warning',
    };

    // api
    config.api = {
      tag: 'api',
      services: [
        // "StatsService"
      ],
    };

    // 本地监听
    if (UIServerConfig.InboundCustom) {
      config.outbounds = UIServerConfig.InboundCustom;
    } else {
      config.inbounds = [
        {
          listen: UIServerConfig.InboundAddress,
          port: UIServerConfig.InboundPort,
          protocol: UIServerConfig.InboundProtocol,
          sniffing: {
            enabled: UIServerConfig.sniffingEnabled,
            destOverride: ['http', 'tls', 'quic'],
            routeOnly: true,
          },
          settings: {
            clients: [
              {
                id: UIServerConfig.InboundUUID,
                email: 'user@exmaple.com',
                flow: UIServerConfig.InboundFlow,
              },
            ],
            decryption: UIServerConfig.InboundDecryption || 'none',
          },
          streamSettings: {
            network: UIServerConfig.InboundStreamType,
            security: UIServerConfig.InboundStreamSecurity,
            [UIServerConfig.InboundStreamType + 'Settings']: {
              path: UIServerConfig.InboundPath,
            },
          },
          tag: 'main',
        },
      ];
      if (UIServerConfig.InboundStreamType === 'xhttp') {
        (config.inbounds as any)[0].streamSettings.xhttpSettings = {
          path: UIServerConfig.InboundPath,
          mode: UIServerConfig.InboundXHTTPMode,
          extra: UIServerConfig.InboundXHTTPExtra,
        };
      }
      if (UIServerConfig.InboundStreamSecurity === 'reality') {
        (config.inbounds as any)[0].streamSettings.realitySettings = UIServerConfig.InboundRealityExtra;
      }
    }

    // dns
    if (UIServerConfig.DnsServerCustom) {
      config.dns = {
        servers: UIServerConfig.DnsServerCustom,
      };
    } else {
      config.dns = {
        servers: ['https+local://1.1.1.1/dns-query', '8.8.8.8'],
      };
    }

    // 出站
    if (UIServerConfig.OutboundCustom) {
      config.outbounds = UIServerConfig.OutboundCustom;
    } else {
      config.outbounds = [
        {
          protocol: 'freedom',
          settings: {},
        },
        {
          protocol: 'blackhole',
          settings: {},
          tag: 'blocked',
        },
      ];
    }

    // 路由规则
    if (UIServerConfig.RoutingCustom) {
      config.routing = UIServerConfig.RoutingCustom;
    } else {
      config.routing = {
        rules: [
          {
            inboundTag: ['api'],
            outboundTag: 'api',
            type: 'field',
          },
          // {
          //     ip: [
          //         "geoip:private"
          //     ],
          //     outboundTag: "blocked",
          //     type: "field"
          // },
          {
            outboundTag: 'blocked',
            protocol: ['bittorrent'],
            type: 'field',
          },
        ],
      };
    }

    return config;
  }
}
